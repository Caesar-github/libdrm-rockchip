#!/usr/bin/make -f

###
### Configuration, decide what to build
###

# Some variables:
DEB_HOST_ARCH     ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)
DEB_HOST_ARCH_OS  ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_OS)
DEB_HOST_ARCH_CPU ?= $(shell dpkg-architecture -qDEB_HOST_ARCH_CPU)

confflags = \
	-Dlibkms=true \
	-Dinstall-test-programs=true \
	$()

# Linux vs. the rest:
ifeq (linux, $(DEB_HOST_ARCH_OS))
	confflags += -Dudev=true
else
	confflags += -Dudev=false
endif

# Disable platform drivers
confflags += \
	-Dradeon=false \
	-Damdgpu=false \
	-Dvmwgfx=false \
	-Dnouveau=false \
	-Dintel=false \
	-Dexynos=false \
	-Domap=false \
	-Detnaviv=false \
	-Dtegra=false \
	-Dfreedreno=false

###
### Actual build
###

override_dh_auto_configure:
	dh_auto_configure -- $(confflags)

override_dh_auto_test:

override_dh_install:
	find debian/tmp -name '*.la' -delete
	dh_install

  ifneq (,$(filter $(DEB_HOST_ARCH_CPU),arm))
	for file in debian/tmp/usr/bin/exynos_*; do \
		mv $$file debian/libdrm-tests/usr/bin; \
	done
  endif
#  ifneq (,$(filter $(DEB_HOST_ARCH),armhf arm64))
#	for file in debian/tmp/usr/bin/etnaviv*; do \
#		mv $$file debian/libdrm-tests/usr/bin; \
#	done
#  endif

override_dh_missing:
	dh_missing --fail-missing

override_dh_makeshlibs:
	dh_makeshlibs -plibdrm2 -V'libdrm2 (>= 2.4.89)' --add-udeb=libdrm2-udeb -- -c4
	dh_makeshlibs -plibkms1 -V'libkms1 (>= 2.4.89)' -- -c4

%:
	dh $@ --with quilt \
		--builddirectory=build/ \
		--buildsystem=meson
